<!-- templates/index.html -->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Baseball Chat</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Tailwind configuration for dark mode
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#FF6B6B',
                        secondary: '#4ECDC4',
                        dark: '#2C3E50'
                    }
                }
            }
        }
    </script>
</head>

<body class="bg-white dark:bg-gray-900 transition-colors duration-200">
    <div class="min-h-screen">
        <!-- Navigation Bar -->
        <nav class="bg-primary dark:bg-dark p-4 fixed w-full top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <h1 class="text-white text-2xl font-bold">âš¾ Baseball Chat</h1>
                <div class="flex items-center space-x-4">
                    <button id="darkModeToggle" class="text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z">
                            </path>
                        </svg>
                    </button>
                    <button id="profileBtn" class="text-white">Profile</button>
                    <button id="logoutBtn" class="text-white">Logout</button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <div class="container mx-auto pt-20 px-4 flex flex-col md:flex-row gap-4">
            <!-- Sidebar -->
            <div class="w-full md:w-1/4 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-lg">
                <!-- Search Bar -->
                <div class="mb-4">
                    <input type="text" placeholder="Search users..."
                        class="w-full p-2 rounded border dark:bg-gray-700 dark:text-white">
                </div>

                <!-- Connections List -->
                <div class="mb-4">
                    <h2 class="text-xl font-bold mb-2 dark:text-white">Connections</h2>
                    <div id="connectionsList" class="space-y-2">
                        <!-- Connections will be populated here -->
                    </div>
                </div>

                <!-- Groups List -->
                <div>
                    <h2 class="text-xl font-bold mb-2 dark:text-white">Groups</h2>
                    <button id="createGroupBtn" class="bg-secondary text-white px-4 py-2 rounded mb-2 w-full">
                        Create Group
                    </button>
                    <div id="groupsList" class="space-y-2">
                        <!-- Groups will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="w-full md:w-3/4 bg-gray-100 dark:bg-gray-800 p-4 rounded-lg shadow-lg">
                <div id="chatHeader" class="mb-4">
                    <h2 class="text-2xl font-bold dark:text-white">Select a chat</h2>
                </div>
                <div id="chatMessages" class="h-[500px] overflow-y-auto mb-4 space-y-2">
                    <!-- Messages will be populated here -->
                </div>
                <div id="chatInput" class="flex gap-2">
                    <input type="text" placeholder="Type your message..."
                        class="flex-1 p-2 rounded border dark:bg-gray-700 dark:text-white">
                    <button id="attachmentBtn" class="bg-secondary text-white px-4 py-2 rounded">
                        ðŸ“Ž
                    </button>
                    <button id="sendBtn" class="bg-primary text-white px-4 py-2 rounded">
                        Send
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals will be added here -->
    <div id="createGroupModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center">
        <!-- Modal content -->
    </div>

    <!-- Add these script tags in your HTML head section or before closing body tag -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        // static/js/socket.js

        // Initialize Socket.IO client
        const socket = io();

        // Connection event handlers
        socket.on('connect', () => {
            console.log('Connected to WebSocket server');
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from WebSocket server');
        });

        // Message handling
        socket.on('new_message', (message) => {
            appendMessage(message);
        });

        socket.on('group_joined', (data) => {
            console.log(`Joined group: ${data.group_id}`);
            showNotification(`Joined baseball group chat! âš¾`);
        });

        // Join/Leave group functions
        function joinGroup(groupId) {
            socket.emit('join_group', { group_id: groupId });
        }

        function leaveGroup(groupId) {
            socket.emit('leave_group', { group_id: groupId });
        }

        // Send message function
        function sendSocketMessage(data) {
            socket.emit('send_message', data);
        }
        // main.js
        document.addEventListener('DOMContentLoaded', function () {
            // Search users functionality
            const searchForm = document.getElementById('searchForm');
            if (searchForm) {
                searchForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const searchQuery = document.getElementById('searchQuery').value;
                    try {
                        const response = await fetch('/search_users', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ query: searchQuery })
                        });
                        const data = await response.json();
                        displaySearchResults(data.users);
                    } catch (error) {
                        console.error('Error searching users:', error);
                    }
                });
            }

            // Create group functionality
            const createGroupForm = document.getElementById('createGroupForm');
            if (createGroupForm) {
                createGroupForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const formData = new FormData(createGroupForm);
                    try {
                        const response = await fetch('/create_group', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                name: formData.get('groupName'),
                                description: formData.get('groupDescription')
                            })
                        });
                        const data = await response.json();
                        if (data.success) {
                            alert('Group created successfully!');
                            window.location.reload();
                        }
                    } catch (error) {
                        console.error('Error creating group:', error);
                    }
                });
            }

            // Send catchup request functionality
            function setupCatchupButtons() {
                const catchupButtons = document.querySelectorAll('.send-catchup-btn');
                catchupButtons.forEach(button => {
                    button.addEventListener('click', async () => {
                        const userId = button.getAttribute('data-user-id');
                        try {
                            const response = await fetch('/send_catchup', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                },
                                body: JSON.stringify({ to_user: userId })
                            });
                            const data = await response.json();
                            if (data.success) {
                                button.textContent = 'Request Sent';
                                button.disabled = true;
                            }
                        } catch (error) {
                            console.error('Error sending catchup request:', error);
                        }
                    });
                });
            }

            // Function to display search results
            function displaySearchResults(users) {
                const resultsContainer = document.getElementById('searchResults');
                if (!resultsContainer) return;

                resultsContainer.innerHTML = '';
                users.forEach(user => {
                    const userElement = document.createElement('div');
                    userElement.className = 'user-result p-4 border rounded mb-2 flex justify-between items-center';
                    userElement.innerHTML = `
                <div>
                    <h3 class="font-bold">${user.username}</h3>
                </div>
                <div>
                    <button 
                        class="send-catchup-btn bg-baseball text-white px-4 py-2 rounded"
                        data-user-id="${user.id}">
                        Send Catchup Request
                    </button>
                </div>
            `;
                    resultsContainer.appendChild(userElement);
                });
                setupCatchupButtons();
            }
        });
        // Modify your existing sendMessage function to use WebSocket
        async function sendMessage() {
            if (!messageInput.value.trim() && !fileInput.files.length) return;

            let fileUrl = null;

            // Handle file upload first if there's a file
            if (fileInput.files.length) {
                const formData = new FormData();
                formData.append('file', fileInput.files[0]);

                try {
                    const response = await fetch('/upload_file', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        fileUrl = data.url;
                    }
                } catch (error) {
                    console.error('Error uploading file:', error);
                    showNotification('Failed to upload file', 'error');
                    return;
                }
            }

            // Prepare message data
            const messageData = {
                content: messageInput.value,
                file_url: fileUrl
            };

            if (currentChat) {
                if (currentChat.type === 'user') {
                    messageData.to_user = currentChat.id;
                } else {
                    messageData.to_group = currentChat.id;
                }
            }

            // Send via WebSocket
            sendSocketMessage(messageData);

            // Clear inputs
            messageInput.value = '';
            fileInput.value = '';
        }
        // static/js/main.js
        document.addEventListener('DOMContentLoaded', function () {
            // Dark mode toggle
            const darkModeToggle = document.getElementById('darkModeToggle');
            const html = document.documentElement;

            darkModeToggle.addEventListener('click', () => {
                html.classList.toggle('dark');
                localStorage.setItem('darkMode', html.classList.contains('dark'));
            });

            // Check for saved dark mode preference
            if (localStorage.getItem('darkMode') === 'true') {
                html.classList.add('dark');
            }

            // WebSocket connection
            const ws = new WebSocket(`ws://${window.location.host}/ws`);
            let currentChat = null;

            ws.onmessage = function (event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };

            function handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'message':
                        appendMessage(data);
                        break;
                    case 'catchup_request':
                        handleCatchupRequest(data);
                        break;
                    case 'connection_update':
                        updateConnectionsList();
                        break;
                }
            }

            // Message handling
            function appendMessage(message) {
                const chatMessages = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `p-2 rounded ${message.from_user === currentUserId
                        ? 'bg-primary text-white ml-auto'
                        : 'bg-gray-200 dark:bg-gray-700 dark:text-white'
                    } max-w-[70%] break-words`;

                if (message.file_url) {
                    if (message.file_url.match(/\.(jpg|jpeg|png|gif)$/i)) {
                        messageDiv.innerHTML += `<img src="/uploads/${message.file_url}" class="max-w-full rounded">`;
                    } else {
                        messageDiv.innerHTML += `<a href="/uploads/${message.file_url}" class="text-blue-500 underline" target="_blank">
                    ðŸ“Ž ${message.file_url}</a>`;
                    }
                }

                messageDiv.innerHTML += `<p>${message.content}</p>
            <span class="text-xs opacity-75">${new Date(message.timestamp).toLocaleTimeString()}</span>`;

                chatMessages.appendChild(messageDiv);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            // Send message
            const sendBtn = document.getElementById('sendBtn');
            const messageInput = document.querySelector('#chatInput input');
            const attachmentBtn = document.getElementById('attachmentBtn');
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.pdf,.png,.jpg,.jpeg,.gif';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);

            sendBtn.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') sendMessage();
            });

            async function sendMessage() {
                if (!messageInput.value.trim() && !fileInput.files.length) return;

                const formData = new FormData();
                formData.append('content', messageInput.value);
                if (fileInput.files.length) {
                    formData.append('file', fileInput.files[0]);
                }
                if (currentChat) {
                    if (currentChat.type === 'user') {
                        formData.append('to_user', currentChat.id);
                    } else {
                        formData.append('to_group', currentChat.id);
                    }
                }

                try {
                    const response = await fetch('/send_message', {
                        method: 'POST',
                        body: formData
                    });
                    const data = await response.json();
                    if (data.success) {
                        messageInput.value = '';
                        fileInput.value = '';
                    }
                } catch (error) {
                    console.error('Error sending message:', error);
                }
            }

            attachmentBtn.addEventListener('click', () => fileInput.click());

            // Search functionality
            const searchInput = document.querySelector('input[placeholder="Search users..."]');
            let searchTimeout;

            searchInput.addEventListener('input', (e) => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(async () => {
                    const response = await fetch(`/search_users?query=${e.target.value}`);
                    const data = await response.json();
                    updateSearchResults(data.users);
                }, 300);
            });

            function updateSearchResults(users) {
                const searchResults = document.createElement('div');
                searchResults.className = 'absolute bg-white dark:bg-gray-800 w-full shadow-lg rounded-lg mt-1';
                users.forEach(user => {
                    const userDiv = document.createElement('div');
                    userDiv.className = 'p-2 hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer';
                    userDiv.textContent = user.username;
                    userDiv.onclick = () => sendCatchupRequest(user.id);
                    searchResults.appendChild(userDiv);
                });

                const existingResults = document.querySelector('.search-results');
                if (existingResults) existingResults.remove();

                if (users.length > 0) {
                    searchInput.parentElement.appendChild(searchResults);
                }
            }

            // Catch-up (Connection) Request
            async function sendCatchupRequest(userId) {
                try {
                    const response = await fetch('/send_catchup', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ to_user: userId })
                    });
                    const data = await response.json();
                    if (data.success) {
                        showNotification('Catch-up request sent! âš¾');
                    }
                } catch (error) {
                    console.error('Error sending catch-up request:', error);
                }
            }

            // Groups functionality
            const createGroupBtn = document.getElementById('createGroupBtn');
            const createGroupModal = document.getElementById('createGroupModal');

            createGroupBtn.addEventListener('click', () => {
                createGroupModal.classList.remove('hidden');
                createGroupModal.innerHTML = `
            <div class="bg-white dark:bg-gray-800 p-6 rounded-lg max-w-md w-full">
                <h2 class="text-2xl font-bold mb-4 dark:text-white">Create Baseball Group</h2>
                <input type="text" id="groupName" placeholder="Group Name" 
                       class="w-full p-2 mb-4 rounded border dark:bg-gray-700 dark:text-white">
                <textarea id="groupDescription" placeholder="Group Description" 
                          class="w-full p-2 mb-4 rounded border dark:bg-gray-700 dark:text-white"></textarea>
                <div class="flex justify-end gap-2">
                    <button id="cancelGroupBtn" class="px-4 py-2 rounded bg-gray-300 dark:bg-gray-600">Cancel</button>
                    <button id="confirmGroupBtn" class="px-4 py-2 rounded bg-primary text-white">Create</button>
                </div>
            </div>
        `;

                document.getElementById('cancelGroupBtn').onclick = () => {
                    createGroupModal.classList.add('hidden');
                };

                document.getElementById('confirmGroupBtn').onclick = async () => {
                    const name = document.getElementById('groupName').value;
                    const description = document.getElementById('groupDescription').value;

                    if (!name.trim()) {
                        showNotification('Please enter a group name!', 'error');
                        return;
                    }

                    try {
                        const response = await fetch('/create_group', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({ name, description })
                        });
                        const data = await response.json();
                        if (data.success) {
                            createGroupModal.classList.add('hidden');
                            showNotification('Group created successfully! âš¾');
                            updateGroupsList();
                        }
                    } catch (error) {
                        console.error('Error creating group:', error);
                    }
                };
            });

            // Update lists
            async function updateConnectionsList() {
                try {
                    const response = await fetch('/get_connections');
                    const data = await response.json();
                    const connectionsList = document.getElementById('connectionsList');
                    connectionsList.innerHTML = '';

                    data.connections.forEach(connection => {
                        const connDiv = document.createElement('div');
                        connDiv.className = 'p-2 bg-white dark:bg-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600';
                        connDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <img src="${connection.profile_pic}" alt="" class="w-8 h-8 rounded-full">
                        <span class="dark:text-white">${connection.username}</span>
                    </div>
                `;
                        connDiv.onclick = () => openChat('user', connection.id);
                        connectionsList.appendChild(connDiv);
                    });
                } catch (error) {
                    console.error('Error updating connections:', error);
                }
            }

            async function updateGroupsList() {
                try {
                    const response = await fetch('/get_groups');
                    const data = await response.json();
                    const groupsList = document.getElementById('groupsList');
                    groupsList.innerHTML = '';

                    data.groups.forEach(group => {
                        const groupDiv = document.createElement('div');
                        groupDiv.className = 'p-2 bg-white dark:bg-gray-700 rounded cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-600';
                        groupDiv.innerHTML = `
                    <div class="flex items-center gap-2">
                        <span class="text-xl">âš¾</span>
                        <span class="dark:text-white">${group.name}</span>
                    </div>
                `;
                        groupDiv.onclick = () => openChat('group', group.id);
                        groupsList.appendChild(groupDiv);
                    });
                } catch (error) {
                    console.error('Error updating groups:', error);
                }
            }

            // Chat handling
            function openChat(type, id) {
                currentChat = { type, id };
                const chatMessages = document.getElementById('chatMessages');
                chatMessages.innerHTML = '';
                loadChatHistory(type, id);

                // Update chat header
                const chatHeader = document.getElementById('chatHeader');
                chatHeader.innerHTML = `
            <div class="flex items-center gap-2">
                <h2 class="text-2xl font-bold dark:text-white">
                    ${type === 'user' ? 'Chat with ' + getUserName(id) : getGroupName(id)}
                </h2>
            </div>
        `;
            }

            async function loadChatHistory(type, id) {
                try {
                    const response = await fetch(`/get_messages?type=${type}&id=${id}`);
                    const data = await response.json();
                    data.messages.forEach(message => appendMessage(message));
                } catch (error) {
                    console.error('Error loading chat history:', error);
                }
            }

            // Utility functions
            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 p-4 rounded shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-red-500'
                    } text-white`;
                notification.textContent = message;
                document.body.appendChild(notification);
                setTimeout(() => notification.remove(), 3000);
            }

            function getUserName(id) {
                // This should be replaced with actual user data from your application state
                return `User ${id}`;
            }

            function getGroupName(id) {
                // This should be replaced with actual group data from your application state
                return `Group ${id}`;
            }

            // Initial loads
            updateConnectionsList();
            updateGroupsList();
        });
    </script>
</body>

</html>